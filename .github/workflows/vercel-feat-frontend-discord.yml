name: Notify Discord of Vercel Deployment (frontend)

on:
  deployment_status:

jobs:
  notify-discord:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Extract commit and deployment info
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          COMMIT_SHA="${{ github.event.deployment.sha }}"
          echo "COMMIT_SHA=${COMMIT_SHA}" >> $GITHUB_ENV

          # Get deployment info
          DEPLOYMENT_REF="${{ github.event.deployment.ref }}"
          DEPLOYMENT_DESC="${{ github.event.deployment.description }}"
          DEPLOYMENT_ENV="${{ github.event.deployment.environment }}"
          
          echo "Debug - Raw deployment info:"
          echo "DEPLOYMENT_REF: $DEPLOYMENT_REF"
          echo "DEPLOYMENT_DESC: $DEPLOYMENT_DESC"
          echo "DEPLOYMENT_ENV: $DEPLOYMENT_ENV"
          
          # Method 1: Try to extract branch from deployment ref (most reliable for current deployment)
          BRANCH=""
          if [[ "$DEPLOYMENT_REF" == refs/heads/* ]]; then
            BRANCH=${DEPLOYMENT_REF#refs/heads/}
            echo "Branch detected from DEPLOYMENT_REF: $BRANCH"
          fi
          
          # Method 2: If ref doesn't give us branch, try deployment environment
          if [ -z "$BRANCH" ] || [ "$BRANCH" = "$DEPLOYMENT_REF" ]; then
            # Check if environment contains branch info
            if [[ "$DEPLOYMENT_ENV" == *"feat-patch"* ]] || [[ "$DEPLOYMENT_ENV" == *"feat/patch"* ]]; then
              BRANCH="feat/patch"
              echo "Branch detected from environment (feat/patch): $BRANCH"
            elif [[ "$DEPLOYMENT_ENV" == *"feat-frontend"* ]] || [[ "$DEPLOYMENT_ENV" == *"feat/frontend"* ]]; then
              BRANCH="feat/frontend"
              echo "Branch detected from environment (feat/frontend): $BRANCH"
            elif [[ "$DEPLOYMENT_ENV" == *"main"* ]] || [[ "$DEPLOYMENT_ENV" == "production"* ]]; then
              BRANCH="main"
              echo "Branch detected from environment (main): $BRANCH"
            fi
          fi
          
          # Method 3: Try deployment description
          if [ -z "$BRANCH" ]; then
            if [[ "$DEPLOYMENT_DESC" == *"feat/patch"* ]]; then
              BRANCH="feat/patch"
              echo "Branch detected from description (feat/patch): $BRANCH"
            elif [[ "$DEPLOYMENT_DESC" == *"feat/frontend"* ]]; then
              BRANCH="feat/frontend"
              echo "Branch detected from description (feat/frontend): $BRANCH"
            elif [[ "$DEPLOYMENT_DESC" == *"main"* ]]; then
              BRANCH="main"
              echo "Branch detected from description (main): $BRANCH"
            fi
          fi
          
          # Method 4: For Vercel, try to get the actual deployed branch from API
          if [ -z "$BRANCH" ]; then
            echo "Trying to get current branches containing this commit..."
            # Get all branches that contain this commit
            BRANCHES=$(gh api "repos/${{ github.repository }}/commits/${COMMIT_SHA}/branches-where-head" --jq -r '.[].name' 2>/dev/null || echo "")
            echo "Branches containing commit: $BRANCHES"
            
            # Priority order: main > feat/patch > feat/frontend > others
            if echo "$BRANCHES" | grep -q "^main$"; then
              BRANCH="main"
              echo "Branch selected: main (priority)"
            elif echo "$BRANCHES" | grep -q "^feat/patch$"; then
              BRANCH="feat/patch"
              echo "Branch selected: feat/patch (priority)"
            elif echo "$BRANCHES" | grep -q "^feat/frontend$"; then
              BRANCH="feat/frontend"
              echo "Branch selected: feat/frontend"
            else
              # Take the first branch if available
              BRANCH=$(echo "$BRANCHES" | head -n1)
              echo "Branch selected: $BRANCH (first available)"
            fi
          fi
          
          # Method 5: Last resort - try to get the default branch or unknown
          if [ -z "$BRANCH" ]; then
            echo "Could not determine branch, using fallback detection..."
            # If deployment is to production environment, assume main
            if [[ "$DEPLOYMENT_ENV" == "production"* ]] || [[ "$DEPLOYMENT_ENV" == "" ]]; then
              BRANCH="main"
              echo "Fallback: production deployment assumed to be main"
            else
              BRANCH="unknown"
              echo "Fallback: could not determine branch"
            fi
          fi
          
          # Get commit info
          if git show --format="%an" -s HEAD >/dev/null 2>&1; then
            AUTHOR=$(git show --format="%an" -s HEAD)
            RAW_MESSAGE=$(git show --format="%s" -s HEAD)
          else
            echo "Git commands failed, trying API..."
            AUTHOR=$(gh api "repos/${{ github.repository }}/commits/${COMMIT_SHA}" --jq -r '.commit.author.name // "Unknown"' 2>/dev/null || echo "Unknown")
            RAW_MESSAGE=$(gh api "repos/${{ github.repository }}/commits/${COMMIT_SHA}" --jq -r '.commit.message // "No message"' 2>/dev/null || echo "No message")
          fi
          
          # Process the message - get first line only and truncate
          MESSAGE=$(echo "$RAW_MESSAGE" | head -n 1 | cut -c1-72)
          
          # Sanitize values
          AUTHOR=$(echo "$AUTHOR" | tr -d '\n\r' | cut -c1-50)
          MESSAGE=$(echo "$MESSAGE" | tr -d '\n\r')
          BRANCH=$(echo "$BRANCH" | tr -d '\n\r' | cut -c1-50)

          echo "AUTHOR=$AUTHOR" >> $GITHUB_ENV
          echo "BRANCH=$BRANCH" >> $GITHUB_ENV
          echo "MESSAGE<<EOF" >> $GITHUB_ENV
          echo "$MESSAGE" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          
          # Final debug output
          echo "Final values:"
          echo "COMMIT_SHA: $COMMIT_SHA"
          echo "AUTHOR: $AUTHOR"
          echo "BRANCH: $BRANCH"
          echo "MESSAGE: $MESSAGE"

      - name: Skip if branch is not one of the monitored branches
        run: |
          if [[ "${{ env.BRANCH }}" != "feat/frontend" && "${{ env.BRANCH }}" != "feat/patch" && "${{ env.BRANCH }}" != "main" ]]; then
            echo "Skipping workflow for branch ${{ env.BRANCH }} - only feat/frontend, feat/patch, and main deployments are monitored"
            exit 0
          fi
          echo "Proceeding with notification for branch: ${{ env.BRANCH }}"

      - name: Send to Discord
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          DEPLOYMENT_ENV: ${{ github.event.deployment.environment }}
        if: env.BRANCH == 'feat/frontend' || env.BRANCH == 'feat/patch' || env.BRANCH == 'main'
        run: |
          STATUS="${{ github.event.deployment_status.state }}"
          ENVIRONMENT="${{ github.event.deployment.environment }}"
          URL="${{ github.event.deployment_status.environment_url }}"
          WORKFLOW_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          COLOR=65280
          EMOJI="✅"

          if [ "$STATUS" != "success" ]; then
            COLOR=16711680
            EMOJI="❌"
          fi

          # Escape JSON special characters in variables
          ESCAPED_BRANCH=$(echo "$BRANCH" | sed 's/\\/\\\\/g' | sed 's/"/\\"/g')
          ESCAPED_AUTHOR=$(echo "$AUTHOR" | sed 's/\\/\\\\/g' | sed 's/"/\\"/g')
          ESCAPED_MESSAGE=$(echo "$MESSAGE" | sed 's/\\/\\\\/g' | sed 's/"/\\"/g')
          ESCAPED_URL=$(echo "$URL" | sed 's/\\/\\\\/g' | sed 's/"/\\"/g')
          ESCAPED_WORKFLOW_URL=$(echo "$WORKFLOW_URL" | sed 's/\\/\\\\/g' | sed 's/"/\\"/g')

          # Create JSON using jq to ensure proper escaping
          jq -n \
            --arg username "Vercel Bot" \
            --arg title "$EMOJI Deployment: $ENVIRONMENT" \
            --argjson color "$COLOR" \
            --arg branch "$ESCAPED_BRANCH" \
            --arg commit "${COMMIT_SHA:0:7}" \
            --arg author "$ESCAPED_AUTHOR" \
            --arg message "$ESCAPED_MESSAGE" \
            --arg url "$ESCAPED_URL" \
            --arg workflow_url "$ESCAPED_WORKFLOW_URL" \
            --arg timestamp "$(date --utc +%Y-%m-%dT%H:%M:%SZ)" \
            '{
              username: $username,
              embeds: [{
                title: $title,
                color: $color,
                description: ("**Branch:** " + $branch + "\n**Commit:** " + $commit + "\n**Author:** " + $author + "\n**Message:** " + $message + "\n**URL:** " + $url + "\n[🔗 View Workflow Run](" + $workflow_url + ")"),
                timestamp: $timestamp
              }]
            }' > payload.json

          # Debug: show the generated JSON
          echo "Generated JSON payload:"
          cat payload.json

          curl -H "Content-Type: application/json" \
               -X POST \
               -d @payload.json \
               "$DISCORD_WEBHOOK_URL"